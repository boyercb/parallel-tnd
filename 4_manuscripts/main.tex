\documentclass[11pt]{article}

\input{setup}

\addbibresource{tnd.bib}

\begin{document}

\begin{titlepage}
\title{Identifying vaccine effectiveness in the test-negative design under an equi-confounding assumption}
\author[1]{Christopher Boyer}%\thanks{email: \href{mailto:cboyer@hsph.harvard.edu}{cboyer@hsph.harvard.edu}}}
\author[2]{Kendrick Qijun Li}
\affil[1]{Department of Epidemiology, Harvard T.H. Chan School of Public Health, Boston, MA.}
\affil[2]{Department of Biostatistics, St. Jude Children's Research Hospital, Memphis, TN.}
\date{\today\vspace{-1em}}
\maketitle

\begin{abstract}
    The test-negative design (TND) is often used to monitor the effectiveness of vaccines under real-world conditions. In a TND study, individuals who develop the same symptoms and seek care are tested for the infectious disease of interest and effectiveness is estimated by comparing the vaccination history of test-positive and test-negative controls. Traditional approaches have justified the TND under the assumption that either a) receipt of a test is a perfect proxy for unmeasured (binary) health-seeking behavior or b) vaccination is unconfounded conditional on measured covariates, both of which are likely to be violated in practice. Here, we return to original motivation for the TND and show that the design may alternatively be justified under an assumption that unmeasured confounder(s) act equivalently for test-positive cases and test-negative controls on the odds ratio scale, i.e. odds ratio equi-confounding. We discuss the implications of this assumption for the design of TNDs. In addition to providing alternative justification for the conventional logistic regression estimator, we derive estimators for the marginal risk ratio among the vaccinated based on outcome modeling and inverse probability weighting using the generalized propensity score. We also derive an estimator based on the efficient influence function allowing for the use of more flexible machine learning models. We provide proofs of our results as well as simulations to examine the finite sample performance of our estimators and illustrate the consequences when our assumptions are violated.
    
\noindent \\
\noindent\textbf{Keywords:} test-negative design, vaccine effectiveness, causal inference, observational studies, unmeasured confounding, equi-confounding, odds ratios, selection bias
\bigskip
\end{abstract}
\setcounter{page}{0}
\thispagestyle{empty}
\end{titlepage}
\pagebreak \newpage

%\doublespacing

\section{Introduction} \label{sec:introduction}
Observational data are frequently used for the post-market evaluation of vaccine effectiveness \cite{chua_use_2020-1,dean_covid-19_2021,patel_postlicensure_2020}. Monitoring the effectiveness of vaccines after initial licensure is important as changes in population immunity as well as antigenic changes to the pathogen of interest occur that may render estimates from pre-market randomized trials less reliable over time \cite{hitchings_effectiveness_2021,israel_elapsed_2021}. Investigators may also be interested in the performance of vaccines in key populations that were ineligible or underrepresented in the clinical trial population \cite{olson_effectiveness_2022}; outcomes and safety signals that may have been underpowered \cite{thompson_effectiveness_2021}; or they may want to compare vaccine formulations against one another or against other therapeutics not considered in the original trial \cite{skowronski_two-dose_2022}. Under these circumstances, a quick and relatively inexpensive study design for estimating vaccine effectiveness is the so-called test-negative design (TND) \cite{sullivan_potential_2014,jackson_test-negative_2013}. 
 
Historically, the term ``test-negative design'' has been applied broadly to any design in which individuals who test positive for a disease of interest are compared with those who test negative. However, there are important methodological differences between approaches. Here, we focus on designs that meet the following criteria: patients with acute respiratory illness are prospectively recruited using a unified symptom screen through hospitals or other care facilities, consented, and a laboratory test for the pathogen of interest is performed. Detailed information about their demographic, medical, and vaccination history is collected via a questionnaire at enrollment or through linked medical and vaccination records. Those who test positive form the ``cases'' and those who test negative are the comparison group. 

The TND has been previously justified on the grounds that, in the presence of unmeasured (binary) healthcare-seeking behavior, the risk ratio against medically attended illness can be identified by the case status odds ratio among those screened and tested at a health facility, provided that the vaccine has no effect on the incidence of other respiratory illnesses that cause similar symptoms \cite{jackson_test-negative_2013}. It was also suggested that, by limiting to individuals who actually received a test, the TND may be less subject to measurement error \cite{jackson_test-negative_2013}. Subsequent work pointed out that the TND (i) is subject to residual confounding when healthcare-seeking is nonbinary or when there are other factors affecting vaccine uptake and risk of infection \cite{sullivan_theoretical_2016,lewnard_theoretical_2021,lipsitch_observational_2016}, (ii) is subject to possible selection bias due to conditioning on the post exposure outcome of receiving a test \cite{sullivan_theoretical_2016,lipsitch_observational_2016}, and (iii) is biased when vaccination has a direct effect on testing behavior \cite{foppa_case_2013}. More recently, \textcite{schnitzer_estimands_2022} introduced a formal causal framework for TND estimands and showed that the marginal risk ratio is identified provided that observed covariates are sufficient to ensure no unmeasured confounding or selection bias. 

However, a question remains as to whether the TND is formally identified under weaker assumptions. In this article, we return to the original motivation for the TND and show that it may be alternatively justified under an assumption that unmeasured confounding is equivalent for test-positive cases and test-negative controls on the odds ratio scale. This assumption builds on the insight that infection with another respiratory illness, if plausibly unaffected by vaccination, is a negative outcome control in the population underlying the TND \cite{lipsitch_negative_2010,shi_selective_2020}. Therefore any observed differences in the incidence of test negative illnesses between vaccinated and unvaccinated individuals likely reflect residual confounding. Under the strong assumption of confounding equivalence between test-positive and test-negative infections, we can then use the difference in test-negative illness to de-bias our estimate of vaccine effectiveness, similar to the parallel trends concept in the difference-in-differences literature \cite{sofer_negative_2016,park_universal_2023,tchetgen_universal_2023}. As we show, this insight extends to the biased sampling of the TND wherein only those who are tested are sampled, if we further assume that (potentially unobserved) determinants of test-seeking behavior are equivalent for test-positive and test-negative illnesses, which could be justified given the causative pathogen is presumably unknown to individuals prior to receiving a test. When our assumptions hold, we show that the traditional odds ratio estimator from the TND identifies the conditional risk ratio among the vaccinated in the population. We also derive new estimators of the marginal risk ratio among the vaccinated, including those based on outcome modeling and inverse probability weighting. We discuss the implications of our assumptions for the design of TNDs and provide proofs of our results as well as simulations to illustrate the consequences when our assumptions are violated.

\section{Setup and observed data} \label{sec:setup}
Let $X$ be a vector of baseline (pre-vaccination) covariates, $V$ an indicator of vaccination status, and $I$ a categorical indicator of symptomatic illness where
        $$I := \begin{cases} 
        I = 2 & \text{when symptomatic illness is caused by the pathogen of interest} \\
        I = 1 & \text{when symptomatic illness is caused by something else} \\
        I = 0 & \text{when no symptomatic illness}
        \end{cases}$$
 Implicit here is the assumption that the infection events represented by $I = 1$ and $I = 2$ are mutually exclusive (this is relaxed in Appendix AX). For convenience, throughout we use the term ``symptomatic'' illness to mean the presence of the pre-specified symptom set used during screening for testing and inclusion in the TND study. Let $T$ be an indicator of receiving a test for the pathogen of interest (0/1), and $I^*$ the result of the test. For now, assume that we have access to a perfect test such that, for all individuals, $I^*_i = \mathbbm{1}(I_i = 2, T_i = 1)$, where $\mathbbm{1}(\cdot)$ is the indicator function. Extensions to cases where the test is imperfect are covered in Appendix \ref{sec:testing} but also have been considered previously \cite{jackson2015effects, sullivan_theoretical_2016}. Throughout we denote by $I^v$ the potential outcome under an intervention that sets vaccination to $V=v$. 
    
We assume the data from the TND are independent realizations of 
$$O = \{(X_i, V_i, S_i = 1, I^*_i) : i = 1, \ldots, n\}$$
where $S$ is an indicator of selection into test-negative design under potentially biased sampling from the underlying target population. Selection is minimally based on presenting with a set of pre-specified symptoms at a health facility and receiving a test, i.e. $S = \mathbbm{1}(I \neq 0, T = 1)$, but could be extended to include other criteria such as hospitalization or severe disease. We assume that the symptom screen is effective such that everyone tested has either $I=1$ or $I=2$. Vaccination status and associated covariates may be retrospectively assessed at the time of testing or, preferably, pulled from outside sources such as vaccine registries or healthcare databases. 

\section{Causal estimands for the test-negative design} \label{sec:estimands}
In a TND study, the target parameter is typically the causal risk ratio,
\begin{equation*}
    \Psi_{RR} \equiv \dfrac{\Pr[I^1 = 2, T^1 = 1]}{\Pr[I^0 = 2, T^0 = 1]},
\end{equation*}
which contrasts the joint probability of symptomatic infection and receipt of a test (i.e. seeking medical care) in the population underlying the TND if everyone were vaccinated compared to if they were unvaccinated, with \textit{vaccine effectiveness} defined as $1 - \Psi_{RR}$. Previous work has sometimes targeted the causal odds ratio in place of the risk ratio, although we note that this is generally combined, either explicitly or implicitly, with an assumption that symptomatic infection is rare in the population underlying the TND over the follow up period such that the odds ratio is also an approximation of the risk ratio. Following the literature, we refer to the joint outcome $\mathbbm{1}(I^1 = 2, T^1 = 1)$ as \textit{medically-attended illness}, under the presumption that, to have been included in the TND, an individual must have had symptomatic illness that precipitated the seeking of medical care. Under the assumption that the measured covariates, $X$, are sufficient to control confounding and selection bias, \Citeauthor*{schnitzer_estimands_2022} \cite{schnitzer_estimands_2022} showed that the odds ratio comparing vaccination among test-positive cases and test-negative controls under the biased sampling of the test-negative design is a consistent estimator of $\Psi_{RR}$. 

Here, we relax this no unmeasured confounding assumption, but, as we will show, to do so requires that we focus instead on the causal risk ratio \textit{among the vaccinated}, i.e.
\begin{equation*}
    \Psi_{RRV} \equiv \dfrac{\Pr[I^1 = 2, T^1 =1 | V = 1]}{\Pr[I^0 = 2, T^0 =1 | V = 1]} .
\end{equation*}
rather than the risk ratio in the full population. This parameter is similar to the average treatment effect on the treated (ATT) in the causal inference literature, although expressed as a ratio rather than a difference. When vaccination provides constant protection for everyone, $\Psi_{RRV}$ will be equivalent to the causal risk ratio in the full population, i.e. $\Psi_{RR} = \Psi_{RRV}$. However, when vaccination provides heterogeneous protection, the causal risk ratio in the full population will be a weighted average of the causal risk ratio among the vaccinated and unvaccinated.

% When there is no direct effect of vaccination on testing (formalized below), then $\Psi_{RR}$ is equivalent to the causal risk ratio for \textit{testing positive} with symptomatic illness,
% \begin{equation*}
%     \Psi_{RR} = \dfrac{\Pr[I^1 = 2, T^1 = 1]}{\Pr[I^0 = 2, T^0 = 1]}.
% \end{equation*}
% Note, this would be true, for instance, in a double-blind placebo-controlled randomized trial in which participants present naturally for testing when they develop symptoms rather than being randomly sampled and tested regardless of symptoms on a given follow up day. In previous work, the joint outcome is sometimes referred to as medically-attended illness \cite{jackson_test-negative_2013}, under the presumption that to receive a test requires sufficiently acute disease to warrant seeking care. 

\section{Identification} \label{sec:identification}
\subsection{Identifiability conditions} \label{sec:conditions}
We consider the identification of the causal risk ratio among the vaccinated, $\Psi_{RRV}$, under the following conditions
\begin{enumerate}[label=\upshape(A\arabic*), ref=A\arabic*]
    \item\label{ass1} Consistency of potential outcomes. For all individuals $i$ and for $v \in \{0, 1\}$, we have $I_i^v = I_i$ and $T_i^v = T_i$ when $V_i = v$. 
    \item\label{ass2} No effect of vaccination on testing negative and symptomatic among the vaccinated. That is, $\Pr[I^0 = 1, T^0=1 | V = 1, X] = \Pr[I^1 = 1, T^1=1 | V = 1, X].$
    \item\label{ass3} Odds ratio equi-confounding. Degree of unmeasured confounding bias on the odds ratio scale is the same for test-positive and test-negative illnesses, i.e. 
    $$OR_2(X) = OR_1(X), $$
    $$ \text{where } OR_i(X) = \frac{\Pr[I^0 = i, T^0 = 1 | V = 1, X]\Pr[T^0 = 0 | V = 0, X]}{\Pr[T^0 = 0 | V = 1, X]\Pr[I^0 = i, T^0 = 1| V = 0, X]}.$$
    \item\label{ass4} Overlap of vaccination among test-positives and test-negatives. Define $\mathcal{S}_i(v)$ as the support of the law of $(I^0 = i, T^0 = 1, V = v, X)$, then for $v$ in $\{0,1\}$, then it must be that $\mathcal{S}_2(1) \subseteq \mathcal{S}_2(0)$ and $\mathcal{S}_2(v) \subseteq \mathcal{S}_1(v).$
    %\item[(A5)] No direct effect of vaccination on test-seeking behavior among the vaccinated. That is, for $i$ in $\{1,2\}$, $\Pr[T^1 = 1 | I^1 = i, V = 1, X] = \Pr[T^0 = 1 | I^0 = i, V = 1, X].$
\end{enumerate}

Assumption \ref{ass1} is a well-known identifiability condition in the causal inference literature discussed in more detail elsewhere \cite{hernan_causal_2020}. Assumption \ref{ass2} has two primary implications. First, it implies that the vaccine does not provide any cross-protection against other types of infection which may cause the same symptoms, including any possible short-term nonspecific protection through activation of the immune system. Second, it also requires that an individual's decision to seek care and get tested is not affected by their vaccination status (although it can depend on other measured and unmeasured characteristics). In principle, \ref{ass2} could be evaluated in a randomized trial by comparing the incidence of testing negative (or testing positive for specific non-target pathogens) across the vaccine and comparison arms, although in practice trials may not be adequately powered to rule out small effects. In a placebo-controlled trial, possible differences in care-seeking are minimized through the blinding of the participant to their vaccination status. Both aspects of \ref{ass2} have been invoked in prior literature on the TND \cite{jackson_test-negative_2013,feng_assessment_2017,schnitzer_estimands_2022}. In Appendix \ref{sec:de_testing}, we show that Assumption \ref{ass2} can be further relaxed provided the effect of vaccination on testing is equivalent for test-positive and test-negative illnesses.

Assumption \ref{ass3} is the key assumption of this paper and is an alternative to the strict conditional independence conditions suggested previously \cite{schnitzer_estimands_2022}. It states that the degree of unmeasured confounding on the odds ratio scale is the same for test-positive and test-negative illnesses. Notably, it does not impose any other restrictions on the unmeasured confounders such as that they must be binary or related to health-seeking specifically (although health-seeking behavior is a credible candidate for satisfying Assumption \ref{ass3}). \citeauthor{lewnard_measurement_2018} briefly discussed identification under a similar condition, although not in a formal causal framework \cite{lewnard_measurement_2018}. It is also similar, in spirit, to a recently suggested scale-independent alternative to the parallel trend assumption in the difference-in-differences literature \cite{park_universal_2023,tchetgen_universal_2023}. Note that, when $I = 1$ and $I = 2$ are mutually exclusive, we can simplify \ref{ass3} to
\begin{equation}
    \frac{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]} =\frac{\Pr[I^0 = 1, T^0 = 1 | V = 1, X]}{\Pr[I^0 = 1, T^0 = 1 | V = 0, X]}
\end{equation}
Furthermore, by a simple factorization we can split \ref{ass3} into alternative assumptions \ref{ass3a} and \ref{ass3b}, emphasizing the dual influences of confounding of the effect of vaccination on symptomatic illness and selection related to receiving a test:
\begin{enumerate}[label=\upshape(A3\alph*), ref=A3\alph*]
    \item\label{ass3a}  Odds ratio equi-confounding. Degree of unmeasured confounding bias on the odds ratio scale is the same for symptomatic illness regardless if $I=1$ or $I=2$ is cause, i.e. 
    $$\frac{\Pr[I^0 = 2 | V = 1, X]}{\Pr[I^0 = 2 | V = 0, X]} =\frac{\Pr[I^0 = 1 | V = 1, X]}{\Pr[I^0 = 1 | V = 0, X]}.$$
    \item\label{ass3b} Odds ratio equi-selection. Degree of unmeasured selection bias, e.g. receiving a test, on the odds ratio scale is the same for all symptomatic illness regardless if $I=1$ or $I=2$ is cause, i.e. 
    $$\frac{\Pr[T^0 = 1 | I^0 = 2, V = 1, X]}{\Pr[T^0 = 1 | I^0 = 2, V = 0, X]} =\frac{\Pr[T^0 = 1 | I^0 = 1, V = 1, X]}{\Pr[T^0 = 1 | I^0 = 1, V = 0, X]}.$$
\end{enumerate}
We note \ref{ass3a} and \ref{ass3b} are slightly stronger than \ref{ass3} alone as \ref{ass3} allows, in principle, for situations in which the factored terms in \ref{ass3a} nor \ref{ass3b} are both unequal but they precisely cancel when multiplied such that \ref{ass3} still holds (although whether such a mechanism is likely to occur in the real world may be doubtful).

Finally, Assumption \ref{ass4} is similar, although less restrictive, than the well-known positivity condition in causal inference \cite{hernan_causal_2020}. Specifically, \ref{ass4} requires overlap of vaccination propensity between the observed vaccinated and unvaccinated among the test positive cases as well as overlap of vaccination propensity across test-positive cases and test-negative controls within observed vaccination groups. Taken together, the conditions $\mathcal{S}_2(1) \subseteq \mathcal{S}_2(0)$ and $\mathcal{S}_2(v) \subseteq \mathcal{S}_1(v)$ ensure that the odds ratios $OR_2(X)$ and $OR_1(X)$ are well-defined (i.e. nonzero in numerator and denominator).

\subsection{Graphical criteria} \label{sec:graphical}
The causal directed acyclic graphs (DAGs) in Figure \ref{fig:dags} represent possible data generating mechanisms underlying the test-negative design. Here we add $U$ to the previous setup representing a possible unmeasured confounder. The DAGs in Figure \ref{fig:dag_a} and \ref{fig:dag_b} show mechanisms discussed previously in the TND literature. Figure \ref{fig:dag_a} is a modified version of the DAG in \citeauthor{schnitzer_estimands_2022} \cite{schnitzer_estimands_2022}, where the assumption of no unmeasured confounding or selection bias is shown by the lack of an arrow from $U$ to $V$. Assumption \ref{ass2} is also shown by the lack of a direct arrow from $V$ to $T$, implying no direct effect of vaccination on testing behavior. Figure \ref{fig:dag_b} is a modified version of the DAG in \citeauthor{sullivan_theoretical_2016} \cite{sullivan_theoretical_2016}, where $U$ is binary health seeking behavior that is synonymous with receiving a test and therefore effectively conditioned on by conditioning on testing.  

The DAG in Figure \ref{fig:dag_c} shows a possible mechanism satisfying the identifiability conditions in this study. It includes the possibility of unmeasured confounding and selection bias, as there is now an arrow from $U$ to $V$; however, as shown by the bold arrows, $U$ is assumed to act equivalently, on the odds scale, for the test positive and test negative illnesses. This condition imposes a parametric restriction on the allowable data generation mechanisms implied by the DAG and as such requires nonstandard notation. The DAGs in Figures \ref{fig:dag_d} and \ref{fig:dag_e} depict alternative mechanisms in which only equi-confounding, Assumption \ref{ass3a}, or equi-selection, Assumption \ref{ass3b}, are assumed. In Figure \ref{fig:dag_split}, we show an alternative DAG that splits the $I$ node into $I_1 = \mathbbm{1}(I = 1)$ and $I_2 = \mathbbm{1}(I = 2)$ with the dashed arrow between them representing the deterministic relationship as they are assumed to be mutually exclusive. This graph allows us to show Assumption \ref{ass2} by the lack of a directed arrow between $V$ and $I_1$. 

\subsection{The test-negative illness as a proxy for unmeasured confounding} \label{sec:effect_among_vaccinated}
To build intuition about the role of identifiability conditions \ref{ass1} - \ref{ass4}, consider briefly identification for the \textit{conditional} causal risk ratio among the vaccinated, i.e.
\begin{equation*}
    \Psi_{RRV}(X) \equiv \frac{\Pr[I^1 = 2, T^1 = 1 | V = 1, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}.
\end{equation*}
Multiplying by one, i.e. $\frac{\Pr[I^0 = 2, T^0 = 1| V = 0, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]}$, and applying consistency (Assumption \ref{ass1}), we find that $\Psi_{RRV}(X)$ satisfies:
\begin{align} \label{eqn:decomposition}
    \Psi_{RRV}(X) &=\underbrace{\frac{\Pr[I = 2, T = 1 | V = 1, X]}{\Pr[I = 2, T = 1 | V = 0, X]}}_{\text{observed risk ratio}} \times \underbrace{\frac{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}}_{\text{de-biasing term}}.
\end{align}
This result implies $\Psi_{RRV}(X)$ can be written as the product of two terms: the (crude) observed risk ratio and a de-biasing term that is equal to the ratio of the potential outcomes under no vaccination between those who were, in fact, vaccinated and those who were not. Note that, when there is no unmeasured confounding, then the de-biasing term is equal to one and the observed risk ratio is equal to the causal risk ratio among the vaccinated. Alternatively, when there is unmeasured confounding, then the de-biasing term is the quantity that would be necessary to remove the bias from the observed risk ratio. However, without further assumptions the de-biasing term is not identified from the observed data. 

One possibility is to use the incidence of test-negative illness in the vaccinated and unvaccinated, which is observed, as a proxy for $\frac{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}$. This could be justified on the grounds that those with test negative illness exhibit a similar propensity for infection and for seeking care when symptomatic. If we further assume that the vaccine has no plausible effect on the test negative illness (Assumption \ref{ass2}), then any observed difference in the incidence of the test-negative illness between the vaccinated and unvaccinated, after conditioning on measured covariates $X$, must reflect residual unmeasured confounding. Under equi-confounding (Assumption \ref{ass3}) it is assumed that the ratio of test-negative illness in the vaccinated and unvaccinated is a perfect proxy for the de-biasing term, $\frac{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}$. That is, by combining \ref{ass1} - \ref{ass3}, we establish that 
\begin{equation}\label{eqn:proxy}
     \dfrac{\Pr[I^0 = 2, T^0 = 1  | V = 1, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 0, X]} = \frac{\Pr[I = 1, T = 1  | V = 1, X]}{\Pr[I = 1, T = 1  | V = 0, X]}.
\end{equation}
In structural terms, \ref{ass3} implies that any unmeasured factors $U$ act with identical effect on both test-positive and test-negative illness on the odds ratio scale (Note in this case, the odds ratio scale is also risk ratio scale as the illnesses are assumed to be mutually exclusive). 
% Therefore, we can use the ratio of $I=1$ among vaccinated and unvaccinated to recalibrate the observed risk ratio for $I = 2$. Indeed, combining \ref{ass1} - \ref{ass3}, we can show that
    
% where we note that $\frac{\Pr[I = 1, T =1  | V = 0, X]}{\Pr[I = 1, T = 1 | V = 1, X]}$ acts as a proxy for $\frac{\Pr[I^0 = 2, T^0 =1  | V = 0, X]}{\Pr[I^0 = 2, T^0 = 1 | V = 1, X]}$ or, borrowing from the difference-in-differences literature, a ``parallel trend'' for $I=2$ in absence of vaccination. 

By substituting the result in equation \ref{eqn:proxy} in place of the de-biasing term in our original decomposition for $\Psi_{RRV}(X)$, we obtain the following 
    \begin{equation}\label{eqn:or_estimand}
         \Psi_{om}(X) \equiv \dfrac{\Pr[I = 2, T = 1 | V = 1, X]/\Pr[I = 1, T = 1 | V = 1, X]}{\Pr[I = 2, T = 1 | V = 0, X]/\Pr[I = 1, T = 1 | V = 0, X]}
    \end{equation}
which is the familiar difference-in-differences estimand on the multiplicative scale where the test-negative illness stands in for the pre-treatment outcome --- essentially a ``parallel'' trend for test-positive illness in the absence of vaccination. We note, $\Psi_{om}(X)$ is written strictly in terms of observable quantities and could, in principle, be estimated using data from the underlying cohort, but it is not identified under the sampling design of the TND. 

However, via a straightforward application of \textcite{breslow 1976}, we can show that $\Psi_{om}(X)$ is equivalent to
\begin{equation}\label{eqn:or_estimand_tnd}
    \Psi^*_{om}(X) = \dfrac{\Pr[I^* = 1 | S = 1, V = 1, X]/\Pr[I^* = 0 | S = 1, V = 1, X]}{\Pr[I^* = 1 | S = 1, V = 0, X]/\Pr[I^* = 0 | S = 1, V = 0, X]}
\end{equation}  
which is identified in the TND. As discussed below, $\Psi^*_{om}(X)$ is a natural target of the commonly used logistic regression estimator in TND studies, suggesting that estimates from existing studies could be alternatively justified under the equi-confounding conditions used here. 

\subsection{Identification in a cohort study}
Consider again the primary estimand of interest, the marginal risk ratio among the vaccinated, $\Psi_{RRV}$. We now apply a similar logic to establish our main identification results. Our first proposition shows that, under the assumptions of section \ref{sec:conditions}, $\Psi_{RRV}$ is identifiable in the underlying cohort. 
\begin{proposition}\label{prop1}
    Given assumptions \ref{app_ass1} - \ref{app_ass4}, $\Psi$ is identifiable under cohort sampling, i.e. 
    $$O_{cohort} = \{(X_i, V_i, I_i, T_i) : i = 1, \ldots, n\},$$ 
    by the expressions 
    \begin{equation}\label{eqn:om_estimand}
        \Psi_{om} \equiv \dfrac{\Pr(I = 2, T = 1 | V = 1)}{E\left\{\Pr(I = 2, T = 1 | V = 0, X) \exp\{\alpha_1(X)\} \Big| V = 1 \right\}}
    \end{equation}
    and 
    \begin{equation}\label{eqn:ipw_estimand}
        \Psi_{ipw} \equiv \dfrac{E\{V \mathbbm 1 (I = 2, T = 1)\}}{E\left\{ (1 - V) \mathbbm 1(I = 2, T = 1) \dfrac{\pi_1(X)}{1 - \pi_1(X)}\right\}}
    \end{equation}
    where $\alpha_1(X) = \log \dfrac{\Pr(I = 1, T = 1 | V = 1, X)}{\Pr(I = 1, T = 1 | V = 0, X)}$ and $\pi_1(X) = \Pr(V = 1| I = 1, T = 1, X)$.
    \end{proposition}

    \begin{proof}
        See Appendix \ref{sec:proof1}.
    \end{proof}
    
%  \begin{equation}\label{eqn:om_estimand}
%     \Psi_{om} \equiv \dfrac{\Pr(I = 2, T = 1 | V = 1)}{E\left\{\Pr(I = 2, T = 1 | V = 0, X) \dfrac{\Pr(I = 1, T = 1 | V = 1, X)}{\Pr(I = 1, T = 1 | V = 0, X)} \Big| V = 1 \right\}},
%  \end{equation}
% and 
% \begin{equation}\label{eqn:ipw_estimand}
%     \Psi_{ipw} \equiv \dfrac{E\{V \mathbbm 1 (I = 2, T = 1)\}}{E\left\{ (1 - V) \mathbbm 1(I = 2, T = 1) \dfrac{\Pr(V = 1| I = 1, T = 1, X)}{\Pr(V = 0| I = 1, T = 1, X)}\right\}},
% \end{equation}
The first expression is a generalization of the result for $\Psi_{om}(X)$ above in which the de-biasing term is now standardized over the distribution of $X$ among the vaccinated. The second expression uses an alternative representation of the de-biasing term based on the invariance property of the odds ratio. That is, by combining the invariance property with conditions \ref{ass1} - \ref{ass4}, we can show that expression \ref{eqn:proxy} is equivalent to
$$\frac{\Pr[I^0 = 2,  T^0 = 1| V = 1, X]}{\Pr[I^0 = 2,  T^0 = 1 | V = 0, X]} = \frac{\Pr[V = 1 | I^0 = 2, T^0 = 1, X]}{\Pr[V = 0 | I^0 = 2, T^0 = 1, X]} =\frac{\Pr[V = 1 | I = 1, T = 1, X]}{\Pr[V = 0 | I = 1, T = 1, X]}$$
and therefore another proxy for the de-biasing term is the odds of vaccination among the test-negative controls. For reasons that will become clear in section \ref{sec:estimation}, we refer to expression \ref{eqn:om_estimand} as the outcome-modeling estimand and expression \ref{eqn:ipw_estimand} as the inverse-probability weighting estimand.

\begin{remark}
The quantity $\pi_2(X) \equiv \Pr[V = 1 | I^0 = 2, T^0 = 1, X]$ is sometimes referred to as the \textit{extended propensity score} (EPS) function as it extends the standard propensity score by conditioning on the treatment-free potential outcome, in this case $I^0 = 2$ and $T^0 = 1$. As shown in previous work, in the presence of unmeasured confounding knowledge of the EPS is sufficient to identify the average treatment effect among the treated. 
\end{remark}

\begin{remark}
Recent work [add cite] has attempted to compare the performance of TND and more modern approaches to cohort studies, such as target trial emulation. However, it is often unclear whether these comparisons are targeting the same estimands. Expression \ref{eqn:or_estimand} as well as expressions \ref{eqn:om_estimand} and \ref{eqn:ipw_estimand} suggest an alternative analysis that could be conducted in the cohort, essentially a difference-in-differences analysis comparing test-positive and test-negative outcomes, that could be a direct comparison for the TND estimands suggested in this paper. 
\end{remark}

\subsection{Identification under outcome-dependent sampling in a TND}

Expressions \ref{eqn:om_estimand} and \ref{eqn:ipw_estimand} require knowledge of the absolute probability of receiving a test. In principle, they could be estimated in a cohort study or population-based study where participants are a random sample from the target population. However, in a TND we observe, potentially biased, data from those who pass the symptom screen and are tested. Nonetheless, our next proposition shows that $\Psi_{RRV}$ is still identifiable under the outcome-dependent sampling scheme of the TND. 
 \begin{proposition}\label{prop2}
      Under test-negative sampling, i.e. 
      $$O_{TND} = \{(X_i, V_i, S_i=1, I^*_i) : i = 1, \ldots, n\},$$ 
      with selection $S = \mathbbm 1(I\neq 0, T = 1)$, $\Psi_{om}$ and $\Psi_{ipw}$ are equivalent to 
    \begin{equation}\label{eqn:om_estimand_tnd}
        \Psi_{om}^* = \dfrac{\Pr(I^* = 1 | S = 1, V = 1)}{E\left\{  \Pr(I^* = 1 | S = 1, V = 0, X) \exp\{\alpha^*_1(X)\}\Big| S = 1, V = 1 \right\}}
    \end{equation}
    and 
    \begin{equation}\label{eqn:ipw_estimand_tnd}
        \Psi_{ipw}^* = \dfrac{E\{VI^*|S =1\}}{E\left\{ (1 - V) I^* \dfrac{\pi^*_0(X)}{1 - \pi^*_0(X)} \bigg| S = 1\right\}}
    \end{equation}
    where $\alpha^*_1(X) = \log \dfrac{\Pr(I^* = 0 | S = 1, V = 1, X)}{\Pr(I^* = 0| S = 1, V = 0, X)}$ and $\pi^*_0(X) = \Pr(V = 1| S = 1, I^* = 0, X)$. Therefore by Proposition \ref{prop1} and assuming conditions \ref{ass1}-\ref{ass4} hold, $\Psi_{om}^*$ and $\Psi_{ipw}^*$ are also identifying expressions for $\Psi$.
 \end{proposition}
 \begin{proof}
    See Appendix \ref{sec:proof2}.
 \end{proof}
    
 Both expression \ref{eqn:om_estimand_tnd} and  \ref{eqn:ipw_estimand_tnd} now condition on selection in the TND and therefore are identifiable based on the observed data. As previously, we refer to expression \ref{eqn:om_estimand_tnd} as the outcome-modeling estimand of the TND and expression \ref{eqn:ipw_estimand_tnd} as the inverse-probability weighting estimand of the TND.

 \begin{remark}
     Comparing expressions \ref{eqn:om_estimand} and \ref{eqn:om_estimand_tnd}, we note that, under our setup, the ``sampling scheme'' of the TND can be viewed as, essentially, outcome-dependent or case-control sampling of an outcome ($I=2, T=1$) and corresponding negative outcome control ($I=1, T =1$). 
 \end{remark}

 \begin{remark}
     Expressions \ref{eqn:om_estimand_tnd} and  \ref{eqn:ipw_estimand_tnd} appear structurally similar to those proposed under unconfoundedness \cite{jiang}. In that work, the authors suggest a class of marginal estimands in a TND that can be written as 
     \begin{equation*}
         \dfrac{E\left[\Pr[I^* = 1 | V = 1, X = x, S = 1]\omega_1(x) | S = 1 \right]}{E\left[\Pr[I^* = 1 | V = 0, X = x, S = 1]\omega_0(x) | S = 1\right]}
     \end{equation*}
     where $\omega_v(x)$ are so-called ``de-biasing weights'' due to their property of adjusting for bias arising from outcome-dependent sampling. They describe weights based on both outcome-modeling and inverse probability weighting. We note that the denominator of both \ref{eqn:om_estimand_tnd} and  \ref{eqn:ipw_estimand_tnd} has a similar form alternative weights 
     \begin{equation*}
         \omega_0(x) \equiv \dfrac{\Pr(I^* = 0 | S = 1, V = 1, X)}{\Pr(I^* = 0| S = 1, V = 0, X)} = \dfrac{\Pr(V=1 | S = 1, I^* = 0, X)}{\Pr(V=0| S = 1, I^* = 0, X)}
     \end{equation*}
     but the function is to simultaneously resolve outcome-dependent sampling and adjust for unmeasured equi-confounding. 
 \end{remark}

\section{Estimation}\label{sec:estimation}
The traditional approach to estimating vaccine effectiveness in a TND is based on logistic regression of $I^*$ conditional on $X$ and $V$, e.g.
$$\log \left\{\dfrac{\Pr[I^* = 1 | S = 1, V, X]}{\Pr[I^* = 0 | S = 1, V, X]}\right\} = \gamma_0 + \gamma_1 V + \gamma_2^t X,$$
where effectiveness is defined as one minus the odds ratio comparing vaccinated and unvaccinated, i.e. $VE = 1 - \exp(\gamma_1)$. As we have shown, $ \exp(\gamma_1)$ is equal to $\Psi^*_{om}(X)$ and by extension the conditional causal risk ratio among the vaccinated $\Psi_{RRV}(X)$ under identifiability conditions \ref{ass1} - \ref{ass4} and correct model specification. 

Alternatively, expressions (\ref{eqn:om_estimand_tnd}) and (\ref{eqn:ipw_estimand_tnd}) suggest two plug-in estimators which are valid under effect modification. Expression (\ref{eqn:om_estimand_tnd}) suggests the plug-in estimator
\begin{equation}\label{eqn:om_estimator}
    \widehat{\Psi}_{om}^* = \dfrac{\sum_{i=1}^n V_i I^*_i}{\sum_{i=1}^n V_i \widehat{\mu}_0(X_i)\dfrac{1 - \widehat{\mu}^*_1(X_i)}{1 - \widehat{\mu}^*_0(X_i)}},
\end{equation}
where $\mu^*_v(X) = \Pr(I^*=1\mid S=1, V=v, X)$ is the probability of testing positive among those with vaccine status $V =v$ in the TND sample, which could be obtained, for instance, by a logistic regression of $I^*$ conditional on $X$ and $V$. Expression (\ref{eqn:ipw_estimand_tnd}), on the other hand, suggests the plug-in estimator
\begin{equation}\label{eqn:ipw_estimator}
    \widehat{\Psi}_{ipw}^* = \dfrac{\sum_{i=1}^n V_i I^*_i}{\sum_{i=1}^n (1 - V_i) I^*_i \dfrac{\widehat\pi_0(X_i)}{1 - \widehat\pi_0(X_i)}},
\end{equation}
where $\pi_0(X) = \Pr(V=1\mid S=1, I^*=0, X)$ is the probability of vaccination among the test-negative controls, which could be obtained, for instance, via a logistic regression of $V$ on $X$ among those with $I^*=0$. In Appendix X, we discuss estimation of standard errors and confidence intervals for $\widehat{\Psi}_{om}^*$ and $\widehat{\Psi}_{ipw}^*$ via bootstrapping or, alternatively, via stacked estimating equations. 

The first estimator, $\widehat{\Psi}_{om}^*$, requires the correct specification of the model for the outcome and the second estimator, $\widehat{\Psi}_{ipw}^*$, requires the correct specification of the the model for the extended propensity score model. In some settings, one estimator may be preferred over the other. For instance, when more is known about the mechanism for ``assigning'' vaccination, the weighting estimator may be preferred \cite{robins_estimating_1992,braitman_rare_2002}; when the process that gives rise to infection and testing is well understood the outcome estimator may be preferred. In practice, however, both models may be difficult to specify correctly. Using data-adaptive and more flexible machine learning estimators for estimation of these nuisance models offers the possibility of capturing more complex data generation processes. These data-adaptive estimators generally have slower rates of convergence than the $\sqrt{n}$ rates of parametric models and therefore will not yield asymptotically valid confidence intervals \cite{chernozhukov_doubledebiased_2018}. To address this challenge, in Appendix \ref{sec:eif}, we derive an estimator based on the efficient influence function for $\Psi_{RRV}$
\begin{equation}\label{eqn:dr_estimator}
    \widehat{\Psi}_{dr}^* = \dfrac{\sum_{i=1}^n V_jI_j^*}{\sum_{j=1}^n\bigg[ (1-V_j)\{I^*_j - \widehat\mu_0(X_j)\}\dfrac{\widehat\pi(X_j)\{1 - \widehat\mu_1(X_j)\}}{\{1 - \widehat\pi(X_j)\}\{1 - \widehat\mu_0(X_j)\}^2} + V_j\{1-I^*_j\}\dfrac{\widehat\mu_0(X_j)}{1-\widehat \mu_0(X_j)}\bigg]}
\end{equation}
In Appendix~\ref{sec:dr}, we show that $\widehat\Psi_{dr}^*$ is consistent if the model for $\mu_0$ and either the model for $\mu_1$ or the model for $\pi$ are correctly specified.

\section{Sensitivity analysis}
In practice, the odds ratio equi-confounding assumption may not hold such that
$$OR_2(X) \neq OR_1(X).$$ 
However, the decomposition in expression (\ref{eqn:decomposition}) suggests a sensitivity analysis which allows for a straightforward departure from equi-confounding as follows. Consider the case that the odds ratio function $OR_2(X)$ is, instead, equal to
\begin{equation}\label{eq:sensitivity-analysis}OR_2(X) = e^{\eta q(X)} OR_1(X) \end{equation}
where $\eta$ is a scalar and $q(X)$ is user-specified a monotone sensitivity function which, when combined, parameterize the departure from equi-confounding on the odds ratio scale. This is an example of the well-known exponential tilt model \cite{scharfstein_adjusting_1999, liu_identification_2020}. Setting $\eta = 0$ corresponds to the case where equi-confounding holds and values of $\eta$ further from zero represent larger violations. For instance, one might specify $q(X) = 1$, which suggests that confounding occurs equally across levels of $X$, and then vary $\eta$ over a grid of values in the interval $(-\omega, \omega)$.

% With similar derivation to Section~\ref{sec:effect_among_vaccinated}, it can be shown that under Equation~\eqref{eq:sensitivity-analysis}, the conditional causal risk ratio $\Psi_{RRV}(X)$ can be identified as
% \begin{equation}
%     \dfrac{\Pr[I = 2, T = 1 | V = 1, X]/\Pr[I = 1, T = 1 | V = 1, X]}{\Pr[I = 2, T = 1 | V = 0, X]/\Pr[I = 1, T = 1 | V = 0, X]}e^{-\eta q(X)}.
% \end{equation}
% That is, the conditional causal risk ratio among the vaccinated and the odds ratio estimated in the test-negative study sample differ by a factor of $e^{-\eta q(X)}$. Furthermore, the marginal risk ratio among the vaccinated $\Psi_{RRV}$ can be identified as 

% $$\dfrac{\Pr(I^* = 1 | S = 1, V = 1)}{E\left\{  \dfrac{\Pr(I^* = 0 | S = 1, V = 1, X)}{\Pr(I^* = 0| S = 1, V = 0, X)}\Pr(I^* = 1 | S = 1, V = 0, X)e^{\eta q(X)} \Big| S = 1, V = 1 \right\}}.$$
% If $q(x)=q_0$ is a constant, then $\Psi_{RRV}=\Psi_{om}^*e^{-\eta q_0}$, that is, the estimated marginal causal risk ratio among vaccinated under Assumptions A1-A5 will also differ by a factor of $e^{\eta q_0}$.

\section{Simulation}

To illustrate a data generation process where our assumptions hold and to verify the empirical performance of the proposed estimators when they do not, we conduct a simulation study mimicking a TND with binary vaccination, testing, and, infection. We consider the following data generation process:
\begin{align*}
    X, U &\sim \text{Unif}(0,1)\\
    V\mid X, U & \sim \text{Bernoulli}(\expit(\alpha_0 + \alpha_X X + \alpha_U U))\\
    I^v \mid V, X, U &\sim \text{Multinomial}(1-p_1(v, X, U), p_1(v, X, U), p_2(v, X, U))\\
    T^v\mid I^v=i, V, X, U &\sim \text{Bernoulli}(\mathbbm 1(i>0)\exp\{\tau_{1}\mathbbm 1(i=1) + \tau_{2}\mathbbm 1(i=2) + \tau_V v + \tau_X X \\&\qquad \qquad\qquad + \tau_U U + \tau_{2U} U \mathbbm 1(i=2) \})
\end{align*}
where $U$ is an unmeasured confounder and
\begin{align*}
    p_1(v, X, U) & = \Pr[I^v = 1 | X, U] = \exp(\beta_{10} + \beta_{1V}v + \beta_{1X}X + \beta_{1VX}vX + \beta_{1U}U) \\
    p_2(v, X, U) & = \Pr[I^v = 2 | X, U] = \exp(\beta_{20} + \beta_{2V}v + \beta_{2X}X + \beta_{2VX}vX + \beta_{2U}U).
\end{align*}
This setup means the potential outcomes $(I^v, T^v)$ for $v=0,1$ and $i=1, 2$ are generated from
\begin{align*}
    \Pr[I^v=0, T^v=1\mid V, X, U] &= 0\\
    \Pr[I^v=i, T^v=1\mid V, X, U] &= p_i(v, X, U)\exp\{\tau_i + \tau_V v + \tau_X X + \tau_U U \\&\qquad \qquad\qquad + \tau_{2U}U\mathbbm 1(I^v=2) \}.
\end{align*}
which implies the conditional independence $(I^v, T^v)\indep V\mid X, U$ holds for $v=0,1$, i.e. conditioning on $U$ and $X$ would be sufficient to control confounding. Furthermore, 
\begin{align*}
    \dfrac{\Pr[I^0=2, T^0=1 \mid V=1,X]}{\Pr[I^0=2, T^0=1\mid V=0,X]}=\dfrac{\E[\exp\{(\tau_U  + \tau_{2U}+\beta_{2U})U\}\mid V=1, X]}{\E[\exp\{(\tau_U  + \tau_{2U}+\beta_{2U})U\}\mid V=0, X]}
\end{align*}
and 
\begin{align*}
    \dfrac{\Pr[I^0=1, T^0=1 \mid V=1,X]}{\Pr[I^0=1, T^0=1\mid V=0,X]}=\dfrac{\E[\exp\{(\tau_U  +\beta_{1U})U\}\mid V=1, X]}{\E[\exp\{(\tau_U +\beta_{1U})U\}\mid V=0, X]}
\end{align*}
implying that Assumtion \ref{ass3} holds when $\beta_{2U}=\beta_{1U}$ and $\tau_{2U}=0$. We note that in our setting, Assumption \ref{ass3} can be viewed as composed of two conditions: the unmeasured confounding bias for two illness outcomes have equal size ($\beta_{1U}=\beta_{2U}$), and there is no interaction between unmeasured confounder and illness outcome in the risk of testing on a multiplicative scale ($\tau_{2U}=0$). Furthermore, $\beta_{1V}=0$ controls whether there is a direct effect of vaccination on $I = 1$, i.e. Assumption \ref{ass2}. Without this assumption, we may at best identify the difference of vaccine effects on the two illness outcomes, i.e. $\beta_{2V}-\beta_{1V}$. The parameters $\tau_V$ and $\tau_{2V}$ control whether there is a direct effect of vaccination on $T$ and whether it is differential between test-negative and test-positive illnesses, i.e. Assumption (A3). Finally, with the assumed simulation setting, we have
\begin{align*}
    \Psi_{RRV} &= \dfrac{Pr(I^1=2, T^1=1\mid V=1)}{Pr(I^0=2, T^0=1\mid V=1)}\\
    &= \dfrac{E\{Pr(I^1=2, T^1=1\mid V=1, X, U)\mid V=1\}}{E\{Pr(I^0=2, T^0=1\mid V=1, X, U)\mid V=1\}}\\
    &= \exp(\beta_{2V})\dfrac{E[\exp\{(\beta_{2X}+\beta_{2VX})X\}\mid V=1]}{E\{\exp(\beta_{2X}X)\mid V=1\}}
\end{align*}


%\textcolor{red}{TODO: Is (A3) necessary?}

We generate a target population of $N = 10,000$ resulting in TND samples of test-positive cases and test-negative controls of between $2000$ and $3000$. We consider nine scenarios: (1) no unmeasured confounding; (2) unmeasured confounding but assumptions (A1)-(A5) hold; (2) equi-confounding holds but equi-selection does not; (3) equi-selection holds but equi-confounding does not; (4) neither equi-confounding nor equi-selection hold; (5) equi-confounding and equi-selection hold but there is a direct effect of vaccination on $I = 1$; (6) equi-confounding and equi-selection hold but there is an equal effect of vaccination on $T$; (7) equi-confounding and equi-selection hold but there is an unequal effect of vaccination on $T$; and (9) all assumptions hold but there is effect modification by covariates $X$. For each scenario, we generate 1000 replicates and estimate the causal risk ratio among the vaccinated using the proposed estimator and calculate the bias and coverage of 95\% confidence intervals based on the true value. For comparison, we also estimate the causal risk ratio among the vaccinated assuming one had access to the full sample in the target population, as in a cohort study. We consider both the more typical case that the covariate $U$ is unmeasured and unavailable and the hypothetical case that $U$ is available and therefore the a sufficient adjustment set can therefore be conditioned on. 

The results are reported in Figure \ref{fig:sims}. When there is no unmeasured confounding, all estimators are unbiased. In all other scenarios the typical cohort estimator without $U$ is biased. When there is unmeasured confounding but assumptions (A1)-(A5) hold, the TND estimator is unbiased. When there is an effect of vaccination on the test-negative illness, the TND estimator is biased; however, it does identify the ratio of vaccine effects against $I = 2$ versus $I = 1$. When equi-confounding or equi-selection are violated the TND estimator is biased. When the the test-negative and test-positive illnesses are not mutually exclusive, the TND estimator is biased for the causal risk ratio but unbiased for the causal odds ratio.  When there is a direct effect of vaccination on testing behavior, the TND estimator remains unbiased if the effect is equivalent for test-negative and test-positive illnesses, but is biased when they are unequal. Finally, the TND estimator remains unbiased in the presence of effect modification. %When there is unmeasured confounding and equi-confounding holds but equi-selection does not, the proposed estimator is biased but has good coverage. When there is unmeasured confounding and equi-selection holds but equi-confounding does not, the proposed estimator is unbiased but has poor coverage. When there is unmeasured confounding and neither equi-confounding nor equi-selection hold, the proposed estimator is biased and has poor coverage. When there is unmeasured confounding and equi-confounding and equi-selection hold but there is a direct effect of vaccination on $I = 1$, the proposed estimator is biased and has poor coverage. When there is unmeasured confounding and equi-confounding and equi-selection hold but there is a direct effect of vaccination on $T$, the proposed estimator is biased and has poor coverage.

\section{Discussion} \label{sec:discussion}

In this article, we have described alternative conditions under which the test-negative design produces an unbiased estimate of the vaccine effectiveness against symptomatic illness in the presence of unmeasured confounding. Specifically, we showed that, as long as the vaccine has no effect on the test-negative illness and unobserved variables act equivalently on symptomatic illness and testing for test-positive and test-negative infections, the TND recovers the true vaccine effectiveness among the vaccinated in the population. While our results apply to commonly-used TND estimator based on logistic regression, we also derived estimators of the marginal effect based on outcome modeling and inverse probability weighting as well as efficient semiparametric approaches based on the efficient influence function. 

To determine whether the equi-confounding assumption is plausible, it would be helpful to know what the source(s) of the test-negative illness are, although this requires additional sampling and testing. In previous TNDs for influenza the most common test-negative illnesses were rhinovirus, respiratory syncytial virus (RSV), human metapneumovirus (hMPV), parainfluenza virus (PIV), bocavirus (BoV), coronavirus (CoV), adenovirus (AdV), enterovirus (EV) and others \cite{chua_use_2020-1}. From our perspective, the ideal test-negative illness would be one with the same transmission mechanism/exposure risk and a similar clinical presentation, but which remains unaffected by the vaccine. A good example, and perhaps the first recorded use of the TND, is in pneumococcal disease, where the vaccine targets certain serotypes of \textit{Streptococcus pneumoniae} but has no effect on other serotypes \cite{broome_pneumococcal_1980}, in which case the non-vaccine serotypes are an ideal test-negative control. Regardless, subject-matter expertise, and in particular, a nuanced understanding of both the biology and the social dynamics governing infection and test-seeking will be required to judge the appropriateness of the equi-confounding assumption on a case-by-case basis. Some examples of unmeasured characteristics where equi-confounding between test-positive and test-negative infections seems more likely include health-seeking and assortativity of mixing. An interesting example of equi-confounding by design is the differential exclusion of person-time immediately post vaccination among the vaccinated such as in TNDs where cases are excluded/marked as unvaccinated if they occur within the first $D$ days after the first or second dose. In a typical observational study such an exclusion would induce immortal time bias \cite{suissa_immortal_2008}. However, as we show in Appendix AX, the TND still produces unbiased estimates as long as this time is excluded equally among the vaccinated for both test-positive cases and test-negative controls. 

Even when equi-confounding is not plausible, as we show in our simulations above, the TND may still yield less biased estimates as compared to conventional cohort approaches based on the same covariate set if the test-negative illness is still a decent proxy for residual confounding. When data from a full cohort are available, such as via large healthcare databases, our results point to an alternative to standard approaches to confounding control, namely by comparing test-positive and test-negative infections via expression (\ref{eqn:cohort_estimand}). This would also permit estimation of the absolute risk under different vaccination regimes. When equi-confounding is implausible, progress can still be made by leveraging additional negative controls. \citeauthor{li_double_2023} describe such an approach in a TND based on two or more proxies for unmeasured confounding \cite{li_double_2023}. Compared to our approach, their method requires a negative control outcome and negative control exposure as well as proper specification of the so-called \textit{treatment-confounding bridge function}. We note that the test-negative illness cannot be used as one of the proxies in this framework because there is not sufficient variation in test-negative versus test-positive illnesses, either because they are mutually exclusive or the joint probability of having both over the study period is sufficiently low.

Our results also rely on the assumption that the vaccine does not affect the incidence of other infections which may cause the same symptoms and the vaccine does not have a direct effect on test-seeking. The former may be violated if either vaccination or infection provides short-term nonspecific protection through activation of the immune system. Previous work has suggested that this may be the case for influenza vaccines \cite{cowling_increased_2012}. However, other results have shown the opposite \cite{sundaram_influenza_2013}. Regardless, as we have shown, as long as the effect of the vaccine on the test-negative illness is in the same direction (presumably protective) the TND estimate is the ratio of the two effects and thus at least a lower bound on true vaccine effectiveness. When vaccination has an effect on test-seeking, as we show in Appendix \ref{sec:de_testing}, the TND estimator remains unbiased provided the effect is the same for test-positive and test-negative infections. This could be plausible if for instance, the knowledge of having received a vaccine makes one feel more protected against the worst outcomes, independent of any biological action, and therefore less likely to go to a clinic when sick. However, if, on the other hand, vaccination affects severity of breakthrough infections for the target pathogen and severity affects the propensity to seek a test then there would be an unequal effect of vaccination on test-seeking and the TND estimate would be biased. In principle, this could be resolved by redefining the outcome to incorporate severity but this requires that severity can be adequately defined and measured for both test-positive and test-negative illnesses. 

We have mainly focused on TNDs conducted in the outpatient setting, where voluntary care-seeking is a major concern. However, TNDs are increasingly conducted in inpatient settings to monitor vaccine effectiveness against hospitalization and death, particularly during the Covid-19 pandemic. In theory our results would apply in the inpatient setting as well although care should be taken as both the composition of test-negative illnesses as well as the source of unmeasured confounding is likely different. %In particular, if (severity)

Throughout we have also focused on effectiveness as defined by the causal risk ratio. Previous work on the TND has often been based the odds ratio \cite{sullivan_theoretical_2016}. The two are approximately equal provided the test-positive infection is rare. Another literature focuses on estimating direct effects of vaccines under different biological mechanisms, such as leaky or all-or-nothing protection, which are useful for parameterizing dynamic models \cite{lewnard_measurement_2018,lewnard_theoretical_2021}. In Appendix \ref{sec:vaccine_modelling}, we discuss the relationship between these direct effects and the casual risk ratio among the vaccinated considered here.

Prior work on the TND suggests that the design could be biased when there is correlation in vaccination behavior for vaccines that target the test positive and test negative illnesses. As shown in the DAG in Figure X this would also violate our identifiability assumptions because it would imply the existence of a confounder that does not affect the test positive and test negative illnesses equally. However, this could be resolved by measuring and adjusting for vaccination for the test negative illness. This further highlights the need to carefully consider and, where possible, document the source of the test negative illnesses. Investigators should also regularly collect full vaccination history.

\newpage

\printbibliography



    \begin{figure}[p]
        \centering
        \begin{subfigure}{0.49\linewidth}
            \centering
            \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.75cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
                \tikzstyle{every state}=[
                  draw = none,
                  fill = none
                ]
                \node[state] (x) {$X$};
                \node[state] (v) [right of=x] {$V$};
                \node[state] (i) [right of=v] {$I$};
                \node[state] (t) [right of=i] {$T$};
                \node[state] (is) [right of=t] {$I^*$};
                \node[state] (u) [below of=v] {$U$};
        
                \path[->] (x) edge node {} (v);
                \path[->] (x) edge [out=45, in=135] node {} (i);
                \path[->] (x) edge [out=45, in=135] node {} (t);
                
                \path[->] (v) edge node {} (i);
                
                \path[->] (i) edge node {} (t);
                \path[->] (i) edge [out=45, in=135] node {} (is);
        
                \path[->] (t) edge node {} (is);
        
                \path[->] (u) edge node {} (x);
                \path[->] (u) edge node {} (i);
                \path[->] (u) edge node {} (t);
                \end{tikzpicture}
            \caption{Unconfoundedness assumption\label{fig:dag_a}}
        \end{subfigure}
        \begin{subfigure}{0.49\linewidth}
            \centering
            \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.75cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
                \tikzstyle{every state}=[
                  draw = none,
                  fill = none
                ]
                \node[state] (x) {$X$};
                \node[state] (v) [right of=x] {$V$};
                \node[state] (i) [right of=v] {$I$};
                \node[state] (t) [right of=i] {$\boxed{T}$};
                \node[state] (is) [right of=t] {$I^*$};
                \node[state] (u) [below of=v] {$\boxed{U}$};
        
                \path[->] (x) edge node {} (v);
                \path[->] (x) edge [out=45, in=135] node {} (i);
                \path[->] (x) edge [out=45, in=135] node {} (t);
                
                \path[->] (v) edge node {} (i);
                
                \path[->] (i) edge node {} (t);
                \path[->] (i) edge [out=45, in=135] node {} (is);
        
                \path[->] (t) edge node {} (is);
        
                \path[->] (u) edge node {} (x);
                \path[->] (u) edge node {} (i);
                \path[->] (u) edge node {} (v);
                \path[-] (u) edge [double, thick, double distance=1pt] node {} (t);
                \end{tikzpicture}
            \caption{Testing synonymous with unmeasured confounding\label{fig:dag_b}}
        \end{subfigure}
        \begin{subfigure}{0.49\linewidth}
        \centering
        \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.75cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
            \tikzstyle{every state}=[
              draw = none,
              fill = none
            ]
            \node[state] (x) {$X$};
            \node[state] (v) [right of=x] {$V$};
            \node[state] (i) [right of=v] {$I$};
            \node[state] (t) [right of=i] {$T$};
            \node[state] (is) [right of=t] {$I^*$};
            \node[state] (u) [below of=v] {$U$};
    
            \path[->] (x) edge node {} (v);
            \path[->] (x) edge [out=45, in=135] node {} (i);
            \path[->] (x) edge [out=45, in=135] node {} (t);
            
            \path[->] (v) edge node {} (i);
            
            \path[->] (i) edge node {} (t);
            \path[->] (i) edge [out=45, in=135] node {} (is);
    
            \path[->] (t) edge node {} (is);
    
            \path[->] (u) edge node {} (x);
            \path[->] (u) edge node {} (v);
            \path[->] (u) edge [line width=2pt] node {} (i);
            \path[->] (u) edge [line width=2pt] node {} (t);
    
    
            % \path[->] (x) edge [dashed] node {} (v);
            % \path[->] (x) edge [dashed] node {} (e);
            % \path[->] (x) edge [dashed] node {} (i);
            % \path[->] (x) edge [dashed] node {} (h);
            % \path[->] (x) edge [dashed] node {} (d);
            
            \end{tikzpicture}
        \caption{Equi-confounding and equi-selection assumptions\label{fig:dag_c}}
        \end{subfigure}
        \begin{subfigure}{0.49\linewidth}
            \centering
            \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.75cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
                \tikzstyle{every state}=[
                  draw = none,
                  fill = none
                ]
                \node[state] (x) {$X$};
                \node[state] (v) [right of=x] {$V$};
                \node[state] (i) [right of=v] {$I$};
                \node[state] (t) [right of=i] {$T$};
                \node[state] (is) [right of=t] {$I^*$};
                \node[state] (u) [below of=v] {$U$};
        
                \path[->] (x) edge node {} (v);
                \path[->] (x) edge [out=45, in=135] node {} (i);
                \path[->] (x) edge [out=45, in=135] node {} (t);
                
                \path[->] (v) edge node {} (i);
                
                \path[->] (i) edge node {} (t);
                \path[->] (i) edge [out=45, in=135] node {} (is);
        
                \path[->] (t) edge node {} (is);
        
                \path[->] (u) edge node {} (x);
                \path[->] (u) edge node {} (v);
                \path[->] (u) edge [line width=2pt] node {} (i);
                % \path[->] (u) edge [line width=2pt] node {} (t);
        
        
                % \path[->] (x) edge [dashed] node {} (v);
                % \path[->] (x) edge [dashed] node {} (e);
                % \path[->] (x) edge [dashed] node {} (i);
                % \path[->] (x) edge [dashed] node {} (h);
                % \path[->] (x) edge [dashed] node {} (d);
                
                \end{tikzpicture}
            \caption{Equi-confounding only\label{fig:dag_d}}
        \end{subfigure}
        \begin{subfigure}{0.49\linewidth}
        \centering
        \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 1.75cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
            \tikzstyle{every state}=[
              draw = none,
              fill = none
            ]
            \node[state] (x) {$X$};
            \node[state] (v) [right of=x] {$V$};
            \node[state] (i) [right of=v] {$I$};
            \node[state] (t) [right of=i] {$T$};
            \node[state] (is) [right of=t] {$I^*$};
            \node[state] (u) [below of=v] {$U$};
    
            \path[->] (x) edge node {} (v);
            \path[->] (x) edge [out=45, in=135] node {} (i);
            \path[->] (x) edge [out=45, in=135] node {} (t);
            
            \path[->] (v) edge node {} (i);
            
            \path[->] (i) edge node {} (t);
            \path[->] (i) edge [out=45, in=135] node {} (is);
    
            \path[->] (t) edge node {} (is);
    
            \path[->] (u) edge node {} (x);
            \path[->] (u) edge node {} (v);
            % \path[->] (u) edge [line width=2pt] node {} (i);
            \path[->] (u) edge [line width=2pt] node {} (t);
    
    
            % \path[->] (x) edge [dashed] node {} (v);
            % \path[->] (x) edge [dashed] node {} (e);
            % \path[->] (x) edge [dashed] node {} (i);
            % \path[->] (x) edge [dashed] node {} (h);
            % \path[->] (x) edge [dashed] node {} (d);
            
            \end{tikzpicture}
        \caption{Equi-selection only\label{fig:dag_e}}
        \end{subfigure}
        \caption{Causal directed acyclic graphs for the test-negative design under alternative assumption sets. Graph (a) shows a mechanism satisfying the unconfoundedness assumption discussed in \cite{schnitzer_estimands_2022} as, conditional on $X$, $V$ and $I$ and $T$ are d-separated. Graph (b) shows a mechanism discussed in \cite{sullivan_theoretical_2016} where $U$ is binary health seeking behavior that is synonymous with receiving a test and therefore effectively conditioned on by conditioning on testing. Graph (c) shows a possible mechanism satisfying the identifiability conditions in Section \ref{sec:conditions} of this paper. It includes the possibility of unmeasured confounding and selection bias by an arbitrary $U$, which could be nonbinary; however, as shown by the bold arrows $U$ is assumed to act equivalently, on the odds scale, for the test positive and test negative illnesses. Graphs (d) and (e) show alternative mechanisms that satisfy equi-confounding or equi-selection only.}\label{fig:dags}
    \end{figure}

    \begin{figure}[p]
        \centering
        \begin{tikzpicture}[> = stealth, shorten > = 1pt, auto, node distance = 2cm, inner sep = 0pt,minimum size = 0.5pt, semithick]
            \tikzstyle{every state}=[
              draw = none,
              fill = none
            ]
            \node[state] (x) {$X$};
            \node[state] (v) [right of=x] {$V$};
            \node[state] (i) [right of=v] {$I_2$};
            \node[state] (t) [right of=i] {$T$};
            \node[state] (is) [right of=t] {$I^*$};
            \node[state] (i1) [below of=i] {$I_1$};
            \node[state] (u) [below of=v] {$U$};
    
            \path[->] (x) edge node {} (v);
            \path[->] (x) edge [out=45, in=135] node {} (i);
    
            \path[->] (v) edge node {} (i);
            
            \path[->] (i) edge [line width=2pt] node {} (t);
            \path[->] (i1) edge [line width=2pt] node {} (t);
            \path[->] (i1) edge node {} (is);
    
            \path[->] (x) edge [out=45, in=135] node {} (t);
    
            \path[->] (t) edge node {} (is);
    
            \path[->] (i) edge [out=45, in=135] node {} (is);
            \path[->] (i1) edge node {} (i);
    
            \path[->] (u) edge node {} (x);
            \path[->] (u) edge node {} (v);
            \path[->] (u) edge [line width=2pt] node {} (i);
            \path[->] (u) edge node {} (t);
            \path[->] (u) edge [line width=2pt] node {} (i1);
            \end{tikzpicture}
        \caption{Splitting $I$ node to show how $I=1$ is a negative outcome control. Dashed line is deterministic relationship as $I = 1$ and $I = 2$ are assumed to be mutually exclusive in the main text.\label{fig:dag_split}}
    \end{figure}
    \clearpage

\begin{figure}
    \centering
    \includegraphics{sims.pdf}
    \caption{Bias of the proposed TND estimator compared to (i) a typical cohort study where $U$ is unmeasured and (ii) an idealized cohort in which $U$ is measured across 9 scenarios representing different true generation processes, based on 1000 Monte Carlo replications. Black dashed line is the true VE. In scenario 3, grey dashed line is the ratio of VEs for test-positive versus test-negative illness. In scenario 5, grey dashed line is one minus the causal odds ratio.}
    \label{fig:sims}
\end{figure}

\clearpage

\input{supplement.tex}

\end{document}